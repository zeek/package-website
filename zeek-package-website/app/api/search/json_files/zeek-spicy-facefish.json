{"description": "A Facefish rootkit detector, based on Spicy.", "tags": null, "version": "v0.1.1", "depends": null, "test_cmd": "cd tests && PATH=$(zkg config plugin_dir)/packages/spicy-plugin/bin:$PATH btest -d -j $(nproc)", "build_cmd": "mkdir -p build && cd build && SPICYZ=$(command -v spicyz || echo %(package_base)s/spicy-plugin/build/bin/spicyz) cmake .. && cmake --build .", "url": "https://github.com/corelight/zeek-spicy-facefish", "summary": "A Facefish rootkit detector, based on Spicy.", "script_dir": "analyzer", "plugin_dir": "build/spicy-modules", "readme": "# Facefish_Rootkit\n\nThis Zeek+Spicy analyzer will detect the Facefish Linux rootkit C2 as described in:\n\n- <https://blog.netlab.360.com/ssh_stealer_facefish_en/>\n- <https://blogs.juniper.net/en-us/threat-research/linux-servers-hijacked-to-implant-ssh-backdoor>\n- <https://thehackernews.com/2021/05/researchers-warn-of-facefish-backdoor.html>\n- <https://securityaffairs.co/wordpress/118388/malware/facefish-backdoor.html>\n\nAn in depth blog and webinar slides on the development of this analyzer can be found here:\n\n- <https://zeek.org/2021/06/10/detecting-the-facefish-linux-rootkit-with-zeek/>\n- <https://docs.google.com/presentation/d/1RRej4BeOF0hTpLVxc0Drg-W5PtI-js1TLcMNC3cTNj0/edit#slide=id.gdfd7e8c66a_0_45>\n\nAny detections will be found in \"facefish_rootkit.log\" while a \"Facefish_Rootkit::FACEFISH_ROOTKIT_C2\" notice\nis also raised.\n\nA testing pcap (that should not detect because there is no KeyEx2) was made\nwith the following command:\n\n```\necho -n -e \\\\x00\\\\x00\\\\x00\\\\x02\\\\x00\\\\x00\\\\x00\\\\x00 | nc 127.0.0.1 9999\n```\n\nThere is a PCAP of the full C2 traffic available here (the second test used for this protocol):\n\n<https://www.joesandbox.com/analysis/355141/0/html#network>\n\nThe output is as follows:\n\n```\n$ zeek -Cr dump-38fb322cc6d09a6ab85784ede56bc5a7.pcap spicy-analyzers\n\n$ cat conn.log\n#separator \\x09\n#set_separator\t,\n#empty_field\t(empty)\n#unset_field\t-\n#path\tconn\n#open\t2021-06-03-14-53-30\n#fields\tts\tuid\tid.orig_h\tid.orig_p\tid.resp_h\tid.resp_p\tproto\tservice\tduration\torig_bytes\tresp_bytes\tconn_state\tlocal_orig\tlocal_resp\tmissed_bytes\thistory\torig_pkts\torig_ip_bytes\tresp_pkts\tresp_ip_bytes\ttunnel_parents\n#types\ttime\tstring\taddr\tport\taddr\tport\tenum\tstring\tinterval\tcount\tcount\tstring\tbool\tbool\tcount\tstring\tcount\tcount\tcount\tcount\tset[string]\n1613702572.079957\tCWc0UD3fGLX0c6bj89\t192.168.2.20\t43448\t176.111.174.26\t443\ttcp\t-\t3.002074\t0\t0\tS0\t-\t-\t0\tS\t3\t180\t0\t0\t-\n1613702572.190619\tCCo5Jp4eSxYMobOp3i\t192.168.2.20\t43450\t176.111.174.26\t443\ttcp\t-\t3.003396\t0\t0\tS0\t-\t-\t0\tS\t3\t180\t0\t0\t-\n1613702579.089432\tCbPIFh4Olo8i1G0KV2\t192.168.2.20\t43448\t176.111.174.26\t443\ttcp\t-\t-\t-\t-\tS0\t-\t-\t0\tS\t1\t60\t0\t0\t-\n1613702579.201449\tCPyuMa4IZGRzzBEOvh\t192.168.2.20\t43450\t176.111.174.26\t443\ttcp\t-\t-\t-\t-\tS0\t-\t-\t0\tS\t1\t60\t0\t0\t-\n1613702587.104275\tC7nx2B1vfFr2VroO59\t192.168.2.20\t43448\t176.111.174.26\t443\ttcp\t-\t-\t-\t-\tS0\t-\t-\t0\tS\t1\t60\t0\t0\t-\n1613702603.150049\tCUcCUW2x5WZS1yWyci\t192.168.2.20\t43448\t176.111.174.26\t443\ttcp\t-\t-\t-\t-\tS0\t-\t-\t0\tS\t1\t60\t0\t0\t-\n1613702635.209441\tChmbMq44oJeZIR6tVf\t192.168.2.20\t43448\t176.111.174.26\t443\ttcp\t-\t-\t-\t-\tS0\t-\t-\t0\tS\t1\t60\t0\t0\t-\n1613702587.216303\tClfyzh4ifzsqqUzvqc\t192.168.2.20\t43450\t176.111.174.26\t443\ttcp\tspicy_facefish_rootkit\t29.625531\t4304\t32\tS1\t-\t-\t0\tShADTad\t19\t5348\t12\t688\t-\n#close\t2021-06-03-14-53-30\n\n$ cat facefish_rootkit.log\n#separator \\x09\n#set_separator\t,\n#empty_field\t(empty)\n#unset_field\t-\n#path\tfacefish_rootkit\n#open\t2021-06-03-14-53-30\n#fields\tts\tuid\tid.orig_h\tid.orig_p\tid.resp_h\tid.resp_p\tis_orig\tpayload_len\tcommand\tcrc32_payload\n#types\ttime\tstring\taddr\tport\taddr\tport\tbool\tcount\tstring\tcount\n1613702587.313451\tClfyzh4ifzsqqUzvqc\t192.168.2.20\t43450\t176.111.174.26\t443\tT\t0\tKeyEx1\t0\n1613702616.553325\tClfyzh4ifzsqqUzvqc\t192.168.2.20\t43450\t176.111.174.26\t443\tF\t24\tKeyEx2\t707025536\n1613702616.557061\tClfyzh4ifzsqqUzvqc\t192.168.2.20\t43450\t176.111.174.26\t443\tT\t8\tKeyEx3\t2984358853\n1613702616.746288\tClfyzh4ifzsqqUzvqc\t192.168.2.20\t43450\t176.111.174.26\t443\tT\t4272\tRegistration\t2325026424\n#close\t2021-06-03-14-53-30\n\n$ cat notice.log\n#separator \\x09\n#set_separator\t,\n#empty_field\t(empty)\n#unset_field\t-\n#path\tnotice\n#open\t2021-06-03-14-53-30\n#fields\tts\tuid\tid.orig_h\tid.orig_p\tid.resp_h\tid.resp_p\tfuid\tfile_mime_type\tfile_desc\tproto\tnote\tmsg\tsub\tsrc\tdst\tp\tn\tpeer_descr\tactions\tsuppress_for\tremote_location.country_code\tremote_location.region\tremote_location.city\tremote_location.latitude\tremote_location.longitude\n#types\ttime\tstring\taddr\tport\taddr\tport\tstring\tstring\tstring\tenum\tenum\tstring\tstring\taddr\taddr\tport\tcount\tstring\tset[enum]\tinterval\tstring\tstring\tstring\tdouble\tdouble\n1613702587.313451\tClfyzh4ifzsqqUzvqc\t192.168.2.20\t43450\t176.111.174.26\t443\t-\t-\t-\ttcp\tFacefish_Rootkit::FACEFISH_ROOTKIT_C2\tPotential Facefish rootkit C2 detected.\tMore info: https://blog.netlab.360.com/ssh_stealer_facefish_en/\t192.168.2.20\t176.111.174.26\t443\t-\t-\tNotice::ACTION_LOG\t60.000000\t-\t-\t-\t-\n#close\t2021-06-03-14-53-30\n```\n"}