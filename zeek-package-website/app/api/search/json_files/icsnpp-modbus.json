{"description": "Modbus script for detailed logging of the Modbus protocol - CISA ICSNPP", "tags": "modbus, Modbus, ics, ICS, CISA, INL, ICSNPP, icsnpp, zeek scripting, log writer, protocol analyzer", "version": "main", "depends": null, "test_cmd": "cd tests && btest -c btest.cfg", "build_cmd": null, "url": "https://github.com/cisagov/icsnpp-modbus", "summary": null, "script_dir": "scripts", "plugin_dir": null, "readme": "# ICSNPP-Modbus\n\nIndustrial Control Systems Network Protocol Parsers (ICSNPP) - Modbus.\n\n## Overview\n\nICSNPP-Modbus is a Zeek package that extends the logging capabilities of Zeek's default Modbus protocol parser.\n\nZeek's default Modbus parser logs Modbus traffic to modbus.log. This log file remains unchanged. This package extends Modbus logging capability by adding three new Modbus log files:\n* modbus_detailed.log\n* modbus_mask_write_register.log\n* modbus_read_write_multiple_registers.log\n\nFor additional information on these log files, see the *Logging Capabilities* section below.\n\n## Installation\n\n### Package Manager\n\nThis script is available as a package for [Zeek Package Manger](https://docs.zeek.org/projects/package-manager/en/stable/index.html)\n\n```bash\nzkg refresh\nzkg install icsnpp-modbus\n```\n\nIf ZKG is configured to load packages (see @load packages in quickstart guide), this script will automatically be loaded and ready to go.\n[ZKG Quickstart Guide](https://docs.zeek.org/projects/package-manager/en/stable/quickstart.html)\n\nIf users are not using site/local.zeek or another site installation of Zeek and want to run this script on a packet capture, they can add `icsnpp-modbus` to the command to run this script on the packet capture:\n\n```bash\ngit clone https://github.com/cisagov/icsnpp-modbus.git\nzeek -Cr icsnpp-modbus/tests/traces/modbus_example.pcap icsnpp-modbus\n```\n\n### Manual Install\n\nTo install this script manually, clone this repository and copy the contents of the scripts directory into `${ZEEK_INSTALLATION_DIR}/share/zeek/site/icsnpp-modbus`.\n\n```bash\ngit clone https://github.com/cisagov/icsnpp-modbus.git\nzeek_install_dir=$(dirname $(dirname `which zeek`))\ncp -r icsnpp-modbus/scripts/ $zeek_install_dir/share/zeek/site/icsnpp-modbus\n```\n\nIf using a site deployment, simply add echo `@load icsnpp-modbus` to the local.site file.\n\nIf users are not using site/local.zeek or another site installation of Zeek and want to run this package on a packet capture, they can add `icsnpp-modbus` to the command to run this plugin's scripts on the packet capture:\n\n```bash\nzeek -Cr icsnpp-modbus/tests/traces/modbus_example.pcap icsnpp-modbus\n```\n\n## Logging Capabilities\n\n### Detailed Modbus Field Log (modbus_detailed.log)\n\n#### Overview\n\nThis log captures Modbus header and data fields and logs them to **modbus_detailed.log**.\n\nThis log file contains the functions (read/write), count, addresses, and values of Modbus coils, discrete inputs, input registers, and holding registers.\n\nA \"network_direction\" meta-data field is also included in the log.  The \"network_direction\" column specifies whether the message was a *request* or a *response* message. \nIf an exception arises in the Modbus data, the exception code will be logged in the \"values\" field.\n\n#### Fields Captured\n\n| Field             | Type      | Description                                                       |\n| ----------------- |-----------|-------------------------------------------------------------------|\n| ts                | time      | Timestamp                                                         |\n| uid               | string    | Unique ID for this connection                                     |\n| id                | conn_id   | Default Zeek connection info (IP addresses, ports)                |\n| is_orig           | bool      | True if the packet is sent from the originator                    |\n| source_h          | address   | Source IP address (see *Source and Destination Fields*)           |\n| source_p          | port      | Source port (see *Source and Destination Fields*)                 |\n| destination_h     | address   | Destination IP address (see *Source and Destination Fields*)      |\n| destination_p     | port      | Destination port (see *Source and Destination Fields*)            |\n| uint_id           | count     | Modbus unit-id                                                    |\n| func              | string    | Modbus function code                                              |\n| request_response  | string    | REQUEST or RESPONSE                                               |\n| address           | count     | Starting address of value(s) field                                |\n| quantity          | count     | Number of addresses/values read or written to                     |\n| values            | string    | Value(s) of coils, discrete_inputs, or registers read/written to  |  \n\n\n### Mask Write Register Log (modbus_mask_write_register.log)\n\n#### Overview\n\nThis log captures the fields of the Modbus *mask_write_register* function (function code 0x16) and logs them to **modbus_mask_write_register.log**.\n\n#### Fields Captured\n\n| Field             | Type      | Description                                                       |\n| ----------------- |-----------|-------------------------------------------------------------------|\n| ts                | time      | Timestamp                                                         |\n| uid               | string    | Unique ID for this connection                                     |\n| id                | conn_id   | Default Zeek connection info (IP addresses, ports)                |\n| is_orig           | bool      | True if the packet is sent from the originator                    |\n| source_h          | address   | Source IP address (see *Source and Destination Fields*)           |\n| source_p          | port      | Source port (see *Source and Destination Fields*)                 |\n| destination_h     | address   | Destination IP address (see *Source and Destination Fields*)      |\n| destination_p     | port      | Destination port (see *Source and Destination Fields*)            |\n| uint_id           | count     | Modbus unit-id                                                    |\n| func              | string    | Modbus function code                                              |\n| request_response  | string    | REQUEST or RESPONSE                                               |\n| address           | count     | Address of the target register                                    |\n| and_mask          | count     | Boolean 'and' mask to apply to the target register                |\n| or_mask           | count     | Boolean 'or' mask to apply to the target register                 |\n\n### Read Write Multiple Registers Log (modbus_read_write_multiple_registers.log)\n\n#### Overview\n\nThis log captures the fields of the Modbus *read/write multiple registers* function (function code 0x17) and logs them to **modbus_read_write_multiple_registers.log**.\n\n#### Fields Captured\n\n| Field                 | Type      | Description                                                   |\n| ----------------------|-----------|---------------------------------------------------------------|\n| ts                    | time      | Timestamp                                                     |\n| uid                   | string    | Unique ID for this connection                                 |\n| id                    | conn_id   | Default Zeek connection info (IP addresses, ports)            |\n| is_orig               | bool      | True if the packet is sent from the originator                |\n| source_h              | address   | Source IP address (see *Source and Destination Fields*)       |\n| source_p              | port      | Source port (see *Source and Destination Fields*)             |\n| destination_h         | address   | Destination IP address (see *Source and Destination Fields*)  |\n| destination_p         | port      | Destination port (see *Source and Destination Fields*)        |\n| uint_id               | count     | Modbus unit-id                                                |\n| func                  | string    | Modbus function code                                          |\n| request_response      | string    | REQUEST or RESPONSE                                           |\n| write_start_address   | count     | Starting address of registers to be written                   |\n| write_registers       | string    | Register values written                                       |\n| read_start_address    | count     | Starting address of the registers to read                     |\n| read_quantity         | count     | Number of registers to read in                                |\n| read_registers        | string    | Register values read                                          |\n\n### Source and Destination Fields\n\n#### Overview\n\nZeek's typical behavior is to focus on and log packets from the originator and not log packets from the responder. However, most ICS protocols contain useful information in the responses, so the ICSNPP parsers log both originator and responses packets. Zeek's default behavior, defined in its `id` struct, is to never switch these originator/responder roles which leads to inconsistencies and inaccuracies when looking at ICS traffic that logs responses.\n\nThe default Zeek `id` struct contains the following logged fields:\n* id.orig_h (Original Originator/Source Host)\n* id.orig_p (Original Originator/Source Port)\n* id.resp_h (Original Responder/Destination Host)\n* id.resp_p (Original Responder/Destination Port)\n\nAdditionally, the `is_orig` field is a boolean field that is set to T (True) when the id_orig fields are the true originators/source and F (False) when the id_resp fields are the true originators/source.\n\nTo not break existing platforms that utilize the default `id` struct and `is_orig` field functionality, the ICSNPP team has added four new fields to each log file instead of changing Zeek's default behavior. These four new fields provide the accurate information regarding source and destination IP addresses and ports:\n* source_h (True Originator/Source Host)\n* source_p (True Originator/Source Port)\n* destination_h (True Responder/Destination Host)\n* destination_p (True Responder/Destination Port)\n\nThe pseudocode below shows the relationship between the `id` struct, `is_orig` field, and the new `source` and `destination` fields.\n\n```\nif is_orig == True\n    source_h == id.orig_h\n    source_p == id.orig_p\n    destination_h == id.resp_h\n    destination_p == id.resp_p\nif is_orig == False\n    source_h == id.resp_h\n    source_p == id.resp_p\n    destination_h == id.orig_h\n    destination_p == id.orig_p\n```\n\n#### Example\n\nThe table below shows an example of these fields in the log files. The first log in the table represents a Modbus request from 192.168.1.10 -> 192.168.1.200 and the second log represents a Modbus reply from 192.168.1.200 -> 192.168.1.10. As shown in the table below, the `id` structure lists both packets as having the same originator and responder, but the `source` and `destination` fields reflect the true source and destination of these packets.\n\n| id.orig_h    | id.orig_p | id.resp_h     | id.resp_p | is_orig | source_h      | source_p | destination_h | destination_p |\n| ------------ | --------- |---------------|-----------|---------|---------------|----------|---------------|-------------- |\n| 192.168.1.10 | 47785     | 192.168.1.200 | 502       | T       | 192.168.1.10  | 47785    | 192.168.1.200 | 502           |\n| 192.168.1.10 | 47785     | 192.168.1.200 | 502       | F       | 192.168.1.200 | 502      | 192.168.1.10  | 47785         |\n\n## ICSNPP Packages\n\nAll ICSNPP Packages:\n* [ICSNPP](https://github.com/cisagov/icsnpp)\n\nFull ICS Protocol Parsers:\n* [BACnet](https://github.com/cisagov/icsnpp-bacnet)\n    * Full Zeek protocol parser for BACnet (Building Control and Automation)\n* [BSAP](https://github.com/cisagov/icsnpp-bsap)\n    * Full Zeek protocol parser for BSAP (Bristol Standard Asynchronous Protocol) over IP\n    * Full Zeek protocol parser for BSAP Serial comm converted using serial tap device\n* [Ethercat](https://github.com/cisagov/icsnpp-ethercat)\n    * Full Zeek protocol parser for Ethercat\n* [Ethernet/IP and CIP](https://github.com/cisagov/icsnpp-enip)\n    * Full Zeek protocol parser for Ethernet/IP and CIP\n* [Genisys](https://github.com/cisagov/icsnpp-genisys)\n    * Full Zeek protocol parser for Genisys\n* [OPCUA-Binary](https://github.com/cisagov/icsnpp-opcua-binary)\n    * Full Zeek protocol parser for OPC UA (OPC Unified Architecture) - Binary\n* [S7Comm](https://github.com/cisagov/icsnpp-s7comm)\n    * Full Zeek protocol parser for S7comm, S7comm-plus, and COTP\n* [Synchrophasor](https://github.com/cisagov/icsnpp-synchrophasor)\n    * Full Zeek protocol parser for Synchrophasor Data Transfer for Power Systems (C37.118)\n\nUpdates to Zeek ICS Protocol Parsers:\n* [DNP3](https://github.com/cisagov/icsnpp-dnp3)\n    * DNP3 Zeek script extending logging capabilities of Zeek's default DNP3 protocol parser\n* [Modbus](https://github.com/cisagov/icsnpp-modbus)\n    * Modbus Zeek script extending logging capabilities of Zeek's default Modbus protocol parser\n\n### License\n\nCopyright 2023 Battelle Energy Alliance, LLC. Released under the terms of the 3-Clause BSD License (see [`LICENSE.txt`](./LICENSE.txt)).\n"}