{"description": "Perform regular network measurements and report results.", "tags": "topk, sumstats", "version": "main", "depends": null, "test_cmd": "cd tests && make", "build_cmd": null, "url": "https://github.com/0xxon/zeek-network-statistics", "summary": null, "script_dir": "scripts", "plugin_dir": null, "readme": "# Easy network statistics with Zeek\n\nThe goal of this repository is to provide convenience scripts to make it easier to create and report aggregate statistics.\n\nThis still is a work and progress; more functionality will be added in the future and functionality might change.\n\nAt the moment, this script contains convenience-functions that allow the easy creation of top-k statistics.\n\n### DNS Query example\n\nTo give a short example, the following script will set up a top-k measurement for the top-DNS names.\n\nPer default, the top-100 DNS hostnames are counted for the last 15 minutes, the last hour and the last day separately, and the information is logged into a dedicated log-file. All of these settings are easily changeable.\n\n```zeek\nevent zeek_init()\n\t{\n\tNetworkStats::create_topk_measurement(\"dns-queries\");\n\t}\n\nevent dns_request(c: connection, msg: dns_msg, query: string, qtype: count, qclass: count)\n\t{\n\tNetworkStats::topk_observation(\"dns-queries\", DNS::query_types[qtype], query);\n\t}\n```\n\nThe resulting log-file is called `topk-dns-queries.log` and looks like this (using a short test trace):\n\n```\n#path\ttopk-dns-queries\n#fields\tts\tduration\tkey\tvalues\tcounts\tepsilons\n#types\ttime\tinterval\tstring\tvector[string]\tvector[count]\tvector[count]\n1300475173.475401\t300.000000\tAAAA\tupload.wikimedia.org,upload.wikimedia.org.ncsa.uiuc.edu,meta.wikimedia.org\t4,4,1\t0,0,0\n1300475173.475401\t300.000000\tA\tupload.wikimedia.org,meta.wikimedia.org\t4,1\t0,0\n1300475173.475401\t900.000000\tAAAA\tupload.wikimedia.org,upload.wikimedia.org.ncsa.uiuc.edu,meta.wikimedia.org\t4,4,1\t0,0,0\n...\n```\n\n## Installation\n\nThis repository is part of the [Zeek Package Manager](https://github.com/zeek/package-manager). It can be installed using the following command:\n\n```bash\nzkg install 0xxon/zeek-network-statistics\n```\n\n## Default logs\n\nAfter installation, the scripts that are part of this repository will, by default, create a number of new log-files. Note that these logs will be created with the default settings that are customizable (see below).\n\nIf you are only interested in creating your own measurements, you can prevent these scripts from being loaded by putting `const NS_NO_MEASUREMENTS = T;` into your `local.zeek` before the `@load packages` line.\n\n### `topk-dns-queries.log`\n\nThe log file `topk-dns-queries.log` contains the top-100 DNS queries for each DNS query-type.\n\n### `topk-http-hosts.log`\n\nThe log file `topk-http-hosts.log` contains the top-100 values encountered in the `HOST` header of HTTP requests.\n\n### `topk-ports.log`\n\nThe log file `topk-ports` lists the top-100 ports that were used for connections, for udp and tcp connections individually. By default this is also split up for incoming and outgoing connections; this behavior is customizable.\n\n## Global Configuration options\n\nA number of global configuration options are available. All of these options also can be changed separately for each measurement.\n\n### `NetworkStats::topk_measurement_intervals` (set of interval)\n\nThis option sets the measurement intervals for the top-k measurements. By default, the measurement intervals are 15 minutes, 1 hour, and 1 day.\n\n### `NetworkStats::topk_top` (count)\n\nThe number of results reported for the measurement. The default value is 100.\n\n### `NetworkStats::topk_size` (count)\n\nThe number of items tracked for the measurement. The default value is 1000.\n\n### `NetworkStats::topk_unified_log` (bool)\n\nIf set to true, measurements will be written into unified log-file (called `ns.log`). Set to false (disabled) by default.\n\n### `NetworkStats::topk_separate_log` (bool)\n\nIf set to true, each measurement will have its own dedicated log-file called `topk-[measurement].log`. Set to true (enabled) by default.\n\n### `NetworkStats::topk_per_interval_logs` (bool)\n\nIf set to true, each measurement will have its own dedicated log-file called `topk-[measurement].log`. Set to false (disabled) by default. Only works if `NetworkStats::topk_separate_log` is also enabled.\n\n## Script-level functions\n\nWe currently export two script-level functions, one for creating top-k measurements and one for submitting observations. These functions are wrappers around the [Summary Statistics Framework](https://docs.zeek.org/en/master/frameworks/sumstats.html) of Zeek, which provided the underlying functionalitu.\n\n### `NetworkStats::create_topk_measurement(name: string, settings: TopKSettings &default=[])`\n\nThe `NetworkStats::create_topk_measurement` function creates a new measurement using the specified `name`. Optionally, a `TopKSettings` record can be passed to the function. The settings record mirrors the global settings above. The full record definition is:\n\n```zeek\ntype TopKSettings: record {\n\t## Number of elements to return\n\ttop: count &default=topk_top;\n\t## Number of elements to keep track of\n\ttopk_size: count &default=topk_size;\n\t## If set to true, will log to a unified log with all other top-k-measurements\n\tunified_log: bool &default=topk_unified_log;\n\t## If set to true, will log to a separate log file.\n\tseparate_log: bool &default=topk_separate_log;\n\t## If not given, the log-path will be \"topk-[name]\"\n\tlog_path: string &optional;\n\t## Measurement intervals for this TopK measurement\n\tmeasurement_intervals: set[interval] &default=copy(topk_measurement_intervals);\n\t## If set to yes, there will be separate logs for each interval. Each log\n\t## will have a \"-interval\" added to the end of the log name. This setting\n\t## only applies if ``separate_log`` is also set to true.\n\tper_interval_logs: bool &default=topk_per_interval_logs;\n};\n```\n\n### `NetworkStats::topk_observation(name: string, key: string, value: string)`\n\nThe `NetworkStats::topk_observation` is our equivalent of the [`SumStats::observe`](https://docs.zeek.org/en/master/scripts/base/frameworks/sumstats/main.zeek.html#id-SumStats::observe) function of the Zeek Summary Statistics framework.\n\nIt submits one observation for the measurement specified by `name`. If several different keys are tracked, a `key` can be specified; otherwise just pass an empty string.\n\n`value` specifies the value of the measurement to be submitted.\n\n## Acknowledgements\n\nThis work was supported by the US National Science Foundation under grant [OAC-1642161](https://nsf.gov/awardsearch/showAward?AWD_ID=1642161&HistoricalAwards=false).\nAny opinions, findings, and conclusions or recommendations\nexpressed in this material are those of the authors or origina-\ntors, and do not necessarily reflect the views of the National\nScience Foundation.\n"}