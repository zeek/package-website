{"description": "A Zeek STUN protocol analyzer based on Spicy.", "tags": null, "version": "v0.2.9", "depends": null, "test_cmd": "cd tests && PATH=$(zkg config plugin_dir)/packages/spicy-plugin/bin:$PATH btest -d -j $(nproc)", "build_cmd": "mkdir -p build && cd build && SPICYZ=$(command -v spicyz || echo %(package_base)s/spicy-plugin/build/bin/spicyz) cmake .. && cmake --build .", "url": "https://github.com/corelight/zeek-spicy-stun", "summary": "A Zeek STUN protocol analyzer based on Spicy.", "script_dir": "analyzer", "plugin_dir": "build/spicy-modules", "readme": "# STUN\n\nSession Traversal Utilities for NAT (STUN)\n\nThis is a Zeek protocol analyzer that detects STUN based on Spicy.\nYou must install [Spicy](https://docs.zeek.org/projects/spicy/en/latest/)\nto use this package.\n\nThis package will create two logs:\n\n- stun.log - This log has every STUN message.\n- stun_nat.log - This log has NAT detections from mapped addresses.\n\nAdditional logic has been added to the original logic found here:\n\n- <https://github.com/r-franke/spicy_stun> (BSD License for original code and PCAP here.)\n- <https://github.com/r-franke/spicy_stun/issues/1> (Permission to move this work over to spicy-analyzers here.)\n\nMore info about STUN:\n\n- <https://datatracker.ietf.org/doc/html/rfc5389>\n- <https://www.iana.org/assignments/stun-parameters/stun-parameters.xhtml>\n- <https://datatracker.ietf.org/doc/html/rfc8489>\n\n## Example\n\n```\n$ zeek -Cr stun-ice-testcall.pcap packages\n\n$ head -n 20 stun.log\n#separator \\x09\n#set_separator\t,\n#empty_field\t(empty)\n#unset_field\t-\n#path\tstun\n#open\t2021-11-23-19-48-14\n#fields\tts\tuid\tid.orig_h\tid.orig_p\tid.resp_h\tid.resp_p\tproto\tis_orig\ttrans_id\tmethod\tclass\tattr_types\tattr_vals\n#types\ttime\tstring\taddr\tport\taddr\tport\tenum\tbool\tstring\tstring\tstring\tvector[string]\tvector[string]\n1377211115.029606\tCHhAvVGS1DHFjwGM9\t192.168.43.155\t60020\t74.125.141.127\t19302\tudp\tT\tSOpCii5Jfc1z\tBINDING\tREQUEST\t(empty)\t(empty)\n1377211115.073291\tCHhAvVGS1DHFjwGM9\t192.168.43.155\t60020\t74.125.141.127\t19302\tudp\tF\tSOpCii5Jfc1z\tBINDING\tRESPONSE_SUCCESS\tMAPPED_ADDRESS\t70.199.128.46:4604\n1377211125.073812\tCHhAvVGS1DHFjwGM9\t192.168.43.155\t60020\t74.125.141.127\t19302\tudp\tT\tKIkrzjV7Aan8\tBINDING\tREQUEST\t(empty)\t(empty)\n1377211125.173831\tCHhAvVGS1DHFjwGM9\t192.168.43.155\t60020\t74.125.141.127\t19302\tudp\tT\tKIkrzjV7Aan8\tBINDING\tREQUEST\t(empty)\t(empty)\n1377211125.183611\tCHhAvVGS1DHFjwGM9\t192.168.43.155\t60020\t74.125.141.127\t19302\tudp\tF\tKIkrzjV7Aan8\tBINDING\tRESPONSE_SUCCESS\tMAPPED_ADDRESS\t70.199.128.46:4604\n1377211125.210098\tCHhAvVGS1DHFjwGM9\t192.168.43.155\t60020\t74.125.141.127\t19302\tudp\tF\tKIkrzjV7Aan8\tBINDING\tRESPONSE_SUCCESS\tMAPPED_ADDRESS\t70.199.128.46:4604\n1377211128.184058\tClEkJM2Vm5giqnMf4h\t192.168.43.155\t59977\t155.212.214.188\t23130\tudp\tT\t5YSnBqpVwa9O\tBINDING\tREQUEST\tUSERNAME,ICE_CONTROLLING,USE_CANDIDATE,PRIORITY,MESSAGE_INTEGRITY,FINGERPRINT\tpLyZHR:GwL3AHBovubLvCqn,\\x18\\x8b\\x10Li{\\xf6[,(empty),1845501695,`+\\xc7\\xfc\\x0d\\x10c\\xaa\\xc58\\x1c\\xcb\\x96\\xa9s\\x08s\\x9a\\x96\\x0c,3512920677\n1377211128.184433\tC4J4Th3PJpwUYZZ6gc\t192.168.43.155\t59977\t155.212.214.188\t23131\tudp\tT\tmPEXdyYbuuQm\tBINDING\tREQUEST\tUSERNAME,ICE_CONTROLLING,USE_CANDIDATE,PRIORITY,MESSAGE_INTEGRITY,FINGERPRINT\tpLyZHR:GwL3AHBovubLvCqn,\\x18\\x8b\\x10Li{\\xf6[,(empty),1845501695,\\xed<\\x90\\xdaN+2\\xd5\\xd3\\xe4\\x8b&\\xdc\\xcd\\xddv\\xbakc\\xe9,3908864856\n1377211128.232201\tCtPZjS20MLrsMUOJi2\t192.168.43.155\t60020\t155.212.214.188\t23130\tudp\tT\takReei85OatV\tBINDING\tREQUEST\tUSERNAME,ICE_CONTROLLING,USE_CANDIDATE,PRIORITY,MESSAGE_INTEGRITY,FINGERPRINT\tpLyZHR:GwL3AHBovubLvCqn,\\x18\\x8b\\x10Li{\\xf6[,(empty),1845501695,x\\xb7\\x14\\xa9\\x9fi\\xf9+\\xcc;\\\\\\xe0\\x0f\\xee\\x911\\x02\\xb9\\x83a,2846465274\n1377211128.232522\tCUM0KZ3MLUfNB0cl11\t192.168.43.155\t60020\t155.212.214.188\t23131\tudp\tT\tK32zssmQHem3\tBINDING\tREQUEST\tUSERNAME,ICE_CONTROLLING,USE_CANDIDATE,PRIORITY,MESSAGE_INTEGRITY,FINGERPRINT\tpLyZHR:GwL3AHBovubLvCqn,\\x18\\x8b\\x10Li{\\xf6[,(empty),1845501695,\\xdb\\xae\\x92\\x92\\xba\\xb9\\xaao\\xf7\\x95\\x98\\xde\\x2c\\xd4\\x9a\\xdae\\xc9\\x2c\\x08,1949326560\n1377211128.280083\tClEkJM2Vm5giqnMf4h\t192.168.43.155\t59977\t155.212.214.188\t23130\tudp\tT\tVPPyM5LqxI7r\tBINDING\tREQUEST\tUSERNAME,ICE_CONTROLLING,USE_CANDIDATE,PRIORITY,MESSAGE_INTEGRITY,FINGERPRINT\tpLyZHR:GwL3AHBovubLvCqn,\\x18\\x8b\\x10Li{\\xf6[,(empty),1845501695, \\x01\\x0e\\x94\\xea\\x90\\x07F\\xa1\\x18\\x87\\x85\\x10{q5\\x9c\\x92)},2756207482\n1377211128.280402\tC4J4Th3PJpwUYZZ6gc\t192.168.43.155\t59977\t155.212.214.188\t23131\tudp\tT\tjDsAa/4ATcQN\tBINDING\tREQUEST\tUSERNAME,ICE_CONTROLLING,USE_CANDIDATE,PRIORITY,MESSAGE_INTEGRITY,FINGERPRINT\tpLyZHR:GwL3AHBovubLvCqn,\\x18\\x8b\\x10Li{\\xf6[,(empty),1845501695,\\xf8\\x98-!\\x0bG\\xa6\\x85\\xcc \\xcf^\\x0b`\\xe6\\xcd::\\xae5,3444520530\n\n$ head -n 20 stun_nat.log\n#separator \\x09\n#set_separator\t,\n#empty_field\t(empty)\n#unset_field\t-\n#path\tstun_nat\n#open\t2021-11-23-19-48-14\n#fields\tts\tuid\tid.orig_h\tid.orig_p\tid.resp_h\tid.resp_p\tproto\tis_orig\twan_addrs\twan_ports\tlan_addrs\n#types\ttime\tstring\taddr\tport\taddr\tport\tenum\tbool\tvector[addr]\tvector[count]\tvector[addr]\n1377211115.073291\tCHhAvVGS1DHFjwGM9\t192.168.43.155\t60020\t74.125.141.127\t19302\tudp\tF\t70.199.128.46\t4604\t192.168.43.155\n1377211125.183611\tCHhAvVGS1DHFjwGM9\t192.168.43.155\t60020\t74.125.141.127\t19302\tudp\tF\t70.199.128.46\t4604\t192.168.43.155\n1377211125.210098\tCHhAvVGS1DHFjwGM9\t192.168.43.155\t60020\t74.125.141.127\t19302\tudp\tF\t70.199.128.46\t4604\t192.168.43.155\n1377211128.309676\tClEkJM2Vm5giqnMf4h\t192.168.43.155\t59977\t155.212.214.188\t23130\tudp\tF\t70.199.128.46\t4587\t192.168.43.155\n1377211128.309677\tC4J4Th3PJpwUYZZ6gc\t192.168.43.155\t59977\t155.212.214.188\t23131\tudp\tF\t70.199.128.46\t4587\t192.168.43.155\n1377211128.358745\tCUM0KZ3MLUfNB0cl11\t192.168.43.155\t60020\t155.212.214.188\t23131\tudp\tF\t70.199.128.46\t4604\t192.168.43.155\n1377211128.359514\tCtPZjS20MLrsMUOJi2\t192.168.43.155\t60020\t155.212.214.188\t23130\tudp\tF\t70.199.128.46\t4604\t192.168.43.155\n1377211128.394673\tClEkJM2Vm5giqnMf4h\t192.168.43.155\t59977\t155.212.214.188\t23130\tudp\tF\t70.199.128.46\t4587\t192.168.43.155\n1377211128.405706\tC4J4Th3PJpwUYZZ6gc\t192.168.43.155\t59977\t155.212.214.188\t23131\tudp\tF\t70.199.128.46\t4587\t192.168.43.155\n1377211128.458800\tC4J4Th3PJpwUYZZ6gc\t192.168.43.155\t59977\t155.212.214.188\t23131\tudp\tF\t70.199.128.46\t4587\t192.168.43.155\n1377211128.459477\tClEkJM2Vm5giqnMf4h\t192.168.43.155\t59977\t155.212.214.188\t23130\tudp\tF\t70.199.128.46\t4587\t192.168.43.155\n1377211128.940537\tClEkJM2Vm5giqnMf4h\t192.168.43.155\t59977\t155.212.214.188\t23130\tudp\tF\t70.199.128.46\t4587\t192.168.43.155\n\n$ cat conn.log\n#separator \\x09\n#set_separator\t,\n#empty_field\t(empty)\n#unset_field\t-\n#path\tconn\n#open\t2021-11-23-19-48-14\n#fields\tts\tuid\tid.orig_h\tid.orig_p\tid.resp_h\tid.resp_p\tproto\tservice\tduration\torig_bytes\tresp_bytes\tconn_state\tlocal_orig\tlocal_resp\tmissed_bytes\thistory\torig_pkts\torig_ip_bytes\tresp_pkts\tresp_ip_bytes\ttunnel_parents\n#types\ttime\tstring\taddr\tport\taddr\tport\tenum\tstring\tinterval\tcount\tcount\tstring\tbool\tbool\tcount\tstring\tcount\tcount\tcount\tcount\tset[string]\n1377211115.029606\tCHhAvVGS1DHFjwGM9\t192.168.43.155\t60020\t74.125.141.127\t19302\tudp\tspicy_stun\t20.187972\t80\t128\tSF\t-\t-\t0\tDd\t4\t192\t4\t240\t-\n1377211128.184058\tClEkJM2Vm5giqnMf4h\t192.168.43.155\t59977\t155.212.214.188\t23130\tudp\tspicy_stun\t7.955804\t2136\t1972\tSF\t-\t-\t0\tDd\t22\t2752\t22\t2588\t-\n1377211128.232201\tCtPZjS20MLrsMUOJi2\t192.168.43.155\t60020\t155.212.214.188\t23130\tudp\tspicy_stun\t0.274303\t288\t288\tSF\t-\t-\t0\tDd\t4\t400\t3\t372\t-\n1377211128.184433\tC4J4Th3PJpwUYZZ6gc\t192.168.43.155\t59977\t155.212.214.188\t23131\tudp\tspicy_stun\t7.955427\t2088\t1872\tSF\t-\t-\t0\tDd\t21\t2676\t21\t2460\t-\n1377211128.232522\tCUM0KZ3MLUfNB0cl11\t192.168.43.155\t60020\t155.212.214.188\t23131\tudp\tspicy_stun\t0.242014\t288\t288\tSF\t-\t-\t0\tDd\t4\t400\t3\t372\t-\n#close\t2021-11-23-19-48-14\n```\n\nTesting Pcaps:\n\n- [stun-ice-testcall.pcap](https://github.com/r-franke/spicy_stun/blob/master/test_data/stun-ice-testcall.pcap)\n- stun-attribute-length-ffff.pcap (self-made)\n- stun-malformed-error.pcap (self-made)\n"}