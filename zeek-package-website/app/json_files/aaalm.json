{"description": "Tag and group devices based on a LAN's structure", "tags": "topology, mapping, visualization, traceroute", "version": "master", "depends": null, "test_cmd": null, "build_cmd": null, "url": "https://github.com/nskelsey/aaalm", "summary": null, "script_dir": "scripts", "plugin_dir": null, "readme": "# aaalm\n\naaalm is a zeek package that passively infers the structure of an IPv4 network over Ethernet from communication among hosts.\n\nIt will discover gateways, routers, and associate devices to subnets and gateways based on hueristics from analysis of raw packets and connections. It can even infer routing paths if the analyzed traffic contains icmp responses to a traceroute.\n\nThe tool inside of `/viz` can then interpret this information to generate a diagram suitable for printing on A4 paper or even bigger on A3, hence the name, the A3 Lan Mapper.\n\nHere are some examples.\n\nWhat a VPS on Amazon can see by running traceroute.\n\n![aws vps diagram](https://raw.githubusercontent.com/nskelsey/aaalm/master/static/aws-vps.png)\n\nThe same diagram in A4\n\n![printed a4 diagram](https://raw.githubusercontent.com/nskelsey/aaalm/master/static/white-boarded-c.jpg)\n\nThe network at my apartment\n\n![My home network](https://raw.githubusercontent.com/nskelsey/aaalm/master/static/home.png)\n\nDuring CTFs teams must attack and defend network services. This is what the network at [DEFCON 27](https://www.defcon.org/html/defcon-27/dc-27-ctf.html) looked like to [mHACKeroni](https://mhackeroni.it/):\n\n![mhack defcon](https://raw.githubusercontent.com/nskelsey/aaalm/master/static/mhack-defcon.png)\n\n## Installation\n\nInstall [Zeek](https://docs.zeek.org/en/stable/quickstart/) and its package manager [zkg](https://docs.zeek.org/projects/package-manager/en/stable/quickstart.html).\n\nUse the `zkg` to download and install the package.\n\n```zsh\n> zkg install aaalm\n```\n\nOtherwise clone this repository.\n\n\n## Usage\n\nRun zeek with the following command with a packet capture file with lots of inter device communication.\n\n```zsh\n> zeek -r path/to/file.pcap -b main.zeek\n```\n\n\nEditing  `Verbose` flag will output a set of subnets that can be used as a starting point to define the `Sites::local_nets` set.\n\n```zsh\n> zeek -r path/to/file.pcap -b main.zeek -e \"redef EtherIPv4::Verbose = T;\"\n```\n\nThe `devices.log` file will contain the inferred network structure, while `subnet.log` will contain the identifed local networks.\n\n\n### Generating the graphics\n\nVisit [my site](https://nskelsey.com/aaalm) to try it out.\n\nThe DIY version requires that you can run a webserver locally. With python3 it's easy:\n\n```\n> python -m http.server -b localhost\n```\n\nNow navigate to [the index](https://localhost:8000/) with your browser and follow the instructions to generate a map.\n\n## Notes\n\n### Performance\n\nNote that this package uses the `raw_packet` event to analyze __every packet__ contained in a pcap or observed on the monitored interface.\nIf you are using a cluster to monitor gigabit loads __do not use__ this package __in realtime__.\nExecution against __hundreds of megabytes__ of traffic produces meaningful output in __less than thirty seconds__.\n\nIf you are monitoring traffic in tens or hundreds of gigabits per second but do not already know your network's layout, you may have __other problems__.\n\n#### Visualizing routing paths\n\nIf your packet capture file contains traffic from programs like traceroute, it's possible to visualize these paths.\n\nNote that only traceroutes performed with low TTL UDP packets which solicit ICMP responses from servers are tracked.\nFurther there is some bug with the signature `detect-low-ttls.sig` that breaks detection even with some UDP traffic.\n\nIn any case the reconstructed route will be logged to the file `tracedroute.log`.\n\n### Techniques Used\n\n#### Placing devices in subnets\nBy default the script uses a greedly algorithm to place addresses into `\\24`.\n\nFor more precise subnet grouping, the script in `analysis/find_subnet.py` will compute a series of statistical tests to determine probable subnet groupings. The script will modify `*.log` the files to improve the quality of subnet groupings if the default behavoir is insufficient.\n\n```zsh\n> python2 subnet_finder.py in-device.log\n# Will output device.log and subnet.log\n```\n\nAfterwards the `net_routes.log` must also be updated by hand to reflect these new changes.\n\n#### Identifying routers\n\nRouter identification works by tracking unique MACs inside of the `l2_header` and storing the set of `ip_src` addresses, then simply checking if these MACs are originating traffic with multiple source IP addresses.\n\n#### Identifying gateways\n\nGateway identification works similiarly but captures the special case where emitted traffic seems to originate from a public IP address.\n"}