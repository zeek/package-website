{"description": "An IPSec Zeek protocol analyzer based on Spicy.", "tags": null, "version": "v0.2.17", "depends": null, "test_cmd": "cd tests && PATH=$(zkg config plugin_dir)/packages/spicy-plugin/bin:$PATH btest -d -j $(nproc)", "build_cmd": "mkdir -p build && cd build && SPICYZ=$(command -v spicyz || echo %(package_base)s/spicy-plugin/build/bin/spicyz) cmake .. && cmake --build .", "url": "https://github.com/corelight/zeek-spicy-ipsec", "summary": "An IPSec Zeek protocol analyzer based on Spicy.", "script_dir": "analyzer", "plugin_dir": "build/spicy-modules", "readme": "# IPSec\n\nThis is a Zeek protocol analyzer that detects IPSec VPN based on Spicy.\nYou must install [Spicy](https://docs.zeek.org/projects/spicy/en/latest/)\nto use this package.\n\nA blog detailing the development of this analyzer:\n\n- <https://zeek.org/2021/04/20/zeeks-ipsec-protocol-analyzer/>\n\nRFCs:\n\n- <https://tools.ietf.org/html/rfc2406> (ESP)\n- <https://tools.ietf.org/html/rfc4302> (AH)\n- <https://tools.ietf.org/html/rfc2408> (IKE v1)\n- <https://tools.ietf.org/html/rfc2409> (IKE v1)\n- <https://tools.ietf.org/html/rfc3948> (ESP packets encapsulated in UDP)\n- <https://tools.ietf.org/html/rfc4306> (IKE v2)\n- <https://tools.ietf.org/html/rfc7296> (IKE v2)\n- <https://tools.ietf.org/html/rfc8229> (ESP packets encapsulated in TCP)\n\n## Example Logs\n\n```\n#separator \\x09\n#set_separator\t,\n#empty_field\t(empty)\n#unset_field\t-\n#path\tconn\n#open\t2021-11-23-13-52-52\n#fields\tts\tuid\tid.orig_h\tid.orig_p\tid.resp_h\tid.resp_p\tproto\tservice\tduration\torig_bytes\tresp_bytes\tconn_state\tlocal_orig\tlocal_resp\tmissed_bytes\thistory\torig_pkts\torig_ip_bytes\tresp_pkts\tresp_ip_bytes\ttunnel_parents\n#types\ttime\tstring\taddr\tport\taddr\tport\tenum\tstring\tinterval\tcount\tcount\tstring\tbool\tbool\tcount\tstring\tcount\tcount\tcount\tcount\tset[string]\n1421270042.835161\tCHhAvVGS1DHFjwGM9\t192.168.0.10\t500\t144.76.154.114\t500\tudp\tspicy_ipsec_ike_udp\t0.032969\t880\t308\tSF\t-\t-\t0\tDd\t1\t908\t1\t336\t-\n1421270042.910124\tClEkJM2Vm5giqnMf4h\t192.168.0.10\t4500\t144.76.154.114\t4500\tudp\tspicy_ipsec_udp\t2.000258\t10416\t0\tS0\t-\t-\t0\tD\t3\t10500\t0\t0\t-\n#close\t2021-11-23-13-52-52\n```\n\n```\n#separator \\x09\n#set_separator\t,\n#empty_field\t(empty)\n#unset_field\t-\n#path\tipsec\n#open\t2021-11-23-13-52-52\n#fields\tts\tuid\tid.orig_h\tid.orig_p\tid.resp_h\tid.resp_p\tis_orig\tinitiator_spi\tresponder_spi\tmaj_ver\tmin_ver\texchange_type\tflag_e\tflag_c\tflag_a\tflag_i\tflag_v\tflag_r\tmessage_id\tvendor_ids\tnotify_messages\ttransforms\tke_dh_groups\tproposals\tcertificates\ttransform_attributes\tlength\thash\n#types\ttime\tstring\taddr\tport\taddr\tport\tbool\tstring\tstring\tcount\tcount\tcount\tbool\tbool\tbool\tbool\tbool\tbool\tcount\tvector[string]\tvector[string]\tvector[string]\tvector[count]\tvector[count]\tvector[string]\tvector[string]\tcount\tstring\n1421270042.835161\tCHhAvVGS1DHFjwGM9\t192.168.0.10\t500\t144.76.154.114\t500\tT\t238671c80375a0fb\t0000000000000000\t2\t0\t34\tF\tF\tF\tT\tF\tF\t0\tMS NT5 ISAKMPOAKLEY,MS-Negotiation Discovery Capable,Microsoft Initial-Contact,UNKNOWN:01528bbbc00696121849ab9a1c5b2a5100000002\tNAT_DETECTION_SOURCE_IP,NAT_DETECTION_DESTINATION_IP\t(empty)\t2\t1,2,3,4,5,6,7,8,9,10,11,12\t(empty)\t(empty)\t880\td1cd39840e0aaa5420b8f65984bb4f5f\n1421270042.868130\tCHhAvVGS1DHFjwGM9\t192.168.0.10\t500\t144.76.154.114\t500\tF\t238671c80375a0fb\t73d16a42f60ef7f0\t2\t0\t34\tF\tF\tF\tF\tF\tT\t0\t(empty)\tNAT_DETECTION_SOURCE_IP,NAT_DETECTION_DESTINATION_IP,MULTIPLE_AUTH_SUPPORTED\t(empty)\t2\t1\t(empty)\t(empty)\t308\tf1885551a5b169444dd961e94d683d61\n1421270042.910124\tClEkJM2Vm5giqnMf4h\t192.168.0.10\t4500\t144.76.154.114\t4500\tT\t238671c80375a0fb\t73d16a42f60ef7f0\t2\t0\t35\tF\tF\tF\tT\tF\tF\t1\t(empty)\t(empty)\t(empty)\t(empty)\t(empty)\t(empty)\t(empty)\t3468\t-\n1421270043.910245\tClEkJM2Vm5giqnMf4h\t192.168.0.10\t4500\t144.76.154.114\t4500\tT\t238671c80375a0fb\t73d16a42f60ef7f0\t2\t0\t35\tF\tF\tF\tT\tF\tF\t1\t(empty)\t(empty)\t(empty)\t(empty)\t(empty)\t(empty)\t(empty)\t3468\t-\n1421270044.910382\tClEkJM2Vm5giqnMf4h\t192.168.0.10\t4500\t144.76.154.114\t4500\tT\t238671c80375a0fb\t73d16a42f60ef7f0\t2\t0\t35\tF\tF\tF\tT\tF\tF\t1\t(empty)\t(empty)\t(empty)\t(empty)\t(empty)\t(empty)\t(empty)\t3468\t-\n#close\t2021-11-23-13-52-52\n```\n\n## Testing PCAPs\n\nThe test suite comes with a set of traces collected from a variety of\nplaces that we document below. While these traces are all coming from\npublic sources, please note that they may carry their own licenses.\nWe collect them here for convenience only.\n\n- [ipsec_client.pcap](https://www.cloudshark.org/captures/9e63e31f9f56)\n- [ikev1-certs.pcap](https://github.com/wireshark/wireshark/blob/master/test/captures/ikev1-certs.pcap)\n- [ipsec-ikev1-isakmp-main-mode.pcap](https://www.cloudshark.org/captures/ff740838f1c2)\n- [ipsec-ikev1-isakmp-aggressive-mode.pcap](https://www.cloudshark.org/captures/e51f5c8a6b24)\n- ipsec-ikev1-payload-bad-length.pcap (self-made)\n- ipsec-ikev1-zero-length.pcap (self-made)\n- [IPsec_ESP-AH_tunnel_mode.cap](https://www.cloudshark.org/captures/dcbaa6ab009b)\n- [ipsec.cap](https://www.cloudshark.org/captures/6ad6e687ed9d)\n"}