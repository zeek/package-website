{"description": "Suite of smtp related policies includes extracting and logging URLs from emails and various smtp anomaly detection heuristics to help flag phishing emails", "tags": "smtp, phish, urls, emails", "version": "master", "depends": null, "test_cmd": "( cd tests && btest -d )", "build_cmd": null, "url": "https://github.com/initconf/smtp-url-analysis", "summary": null, "script_dir": "scripts", "plugin_dir": null, "readme": "===========================\nsmtp-url-analysis\n===========================\n\nThis package/policies have been updated to work with zeek (new broker framework). \n\nPrimary scope of these zeek policies is to give more insights into smtp-analysis esp to track phishing events.\n\nThis is a subset of phish-analysis repo and doesn't use any backed postgres database. So relieves the user from postgres dependency while getting basic phishing detection up and running very quickly.\n\nFollowing functionality are provided by the script\n--------------------------------------------------\n\n::\n        1) Works in a cluster and standalone mode\n        2) extracts URLs from Emails and logs them to smtpurl_links.log\n        3) Tracks these SMTP urls in http analyzer and logs if any of these SMTP URL has been clicked into a file smtp_clicked_urls.log\n        4) Reads a file for malicious indicators and generates an alert of any of those inddicators have a HIT in smtp traffic (see below for more details)\n        5) Generates alerts if suspicious strings are seen in URL (see below for details)\n        6) Generates  alerts if a SMTP URL is clicked resulting in a file download\n\n\nInstallation\n------------\n\tzkg install initconf/smtp-url-analysis\n\tor\n\t@load smtp-url-analysis/scripts\n\nUpgrade\n-------\n\t$ zkg upgrade zeek/initconf/smtp-url-analysis.git\n\tThe following packages will be UPGRADED:\n\t  zeek/initconf/smtp-url-analysis.git (master)\n\n\tProceed? [Y/n] y\n\tRunning unit tests for \"zeek/initconf/smtp-url-analysis.git\"\n\tall 7 tests successful\n\tUpgraded \"zeek/initconf/smtp-url-analysis.git\" (master)\n\n\nDetailed Notes:\n---------------\n\nAll the configuration variables are in the following file. Please modify as needed:\n\n        configure-variables-in-this-file.zeek\n\n        Note: Make sure you replace \"site.org\" in the file with your domain name(s)\n\n\nDetail Alerts and descriptions: Following alerts are generated by the script:\n******************************************************************************\n\nHeuristics in smtp-malicious-indicators.zeek are used to flag known sensitve IoC's (sort of  your local smtp intel feed).\n\nThis should generate following Kinds of notices:\n\n\t- Malicious_MD5,\n\t- Malicious_Attachment,\n\t- Malicious_Indicator,\n\t- Malicious_Mailfrom,\n\t- Malicious_Mailto,\n\t- Malicious_from,\n\t- Malicious_reply_to,\n\t- Malicious_subject,\n\t- Malicious_rcptto,\n\t- Malicious_path,\n\t- Malicious_Decoded_Subject\n\nTo activate these notices a sample smtp_malicious_indicators.out is provided in *\"scripts/feeds\"* directory.  You either need to populate that or *redef* smtp_indicator_feed in configure-variables-in-this-file.zeek:\n\n\tredef Phish::smtp_indicator_feed = \"/feeds/BRO-feeds/smtp_malicious_indicators.out\" ;\n\nI have a cron job which scraps various email indicators (senders, subject, attachment, md5 hash etc) from various phish related feeds/notices and periodically creates this one file: /feeds/BRO-feeds/smtp_malicious_indicators.out. Bro reads this file using input-framework ie  new additions/append/removal to this file doesn't requre zeek to be restarted.\n\nNote:\n\t1) Make sure the fields inthefile are <tab> seperated.\n\t2) Make sure format of above feed file complies to:\n\nHere is a sample format\n\n\t#fields indicator       description\n\t\"At Your Service\" <service@site.org>\tSome random comment\n\tbadsender@example.com\tsome random comment\n\tf402e0713127617bda852609b426caff\tsome bad hash\n\tHelpDesk\tsome bad subject\n\n\nExample alert:\n- Phish::Malicious_rcptto\n\n\tAug 24 11:26:06 CPLZuO3KTSDHx9mCC1      174.15.3.146    36906   18.3.1.10    25      tcp     Phish::Malicious_rcptto Malicious rectto :: [indicator=badsender@example.com, description=random test ], badsender@example.com\tbadsender@example.com\t174.15.3.146 18.3.1.10\t25      zeek     Notice::ACTION_EMAIL,Notice::ACTION_LOG 60.000000       F       -       -       -       -       -\n\n\nsmtp-sensitive-uris.zeek will generate following alerts\n******************************************************\n\n\t- SensitiveURI\n\t- Dotted_URL\n\t- Suspicious_File_URL\n\t- Suspicious_Embedded_Text\n\t- WatchedFileType\n\t- BogusSiteURL\n\n\nExample Alert: BogusSiteURL\n***************************\n\n\n\t1503599166.565855       CPLZuO3KTSDHx9mCC1      1.1.1.1    36906   2.2.2.2    25      -       -       -       tcp     Phish::BogusSiteURL     Very similar URL to site: http://www.site.org.blah.com/ from  1.1.1.1       -       1.1.1.1    2.2.2.2  25      -       zeek     Notice::ACTION_EMAIL,Notice::ACTION_LOG 3600.000000     F       -       -       -       -       -\n\nAgain see configure-variables-in-this-file.zeek for tweaking and tunning\n\n\nExample Alert: FileDownload\n***************************\n\nMalicious file download: If a link in an email is clicked and results in a file download, this module can generate an alert of that as well.\n\n\t1481499234.568566       CQa9SJ1adwAqlPDcKj      1.1.1.1      49067   46.43.34.31     80      FxrREO3dgcnSlAQZO8      application/x-dosexec   http://the.earth.li/~sgtatham/putty/0.67/x86/putty.exe  tcp     Phish::FileDownload     [ts=1481431889.562629, uid=CX5ROKa8g7WcfnET4, from=Bad Guy <random@gmail.com>, to=John Doe <jd@site.org>, subject=putty.exe, referrer=[]]        http://the.earth.li/~sgtatham/putty/0.67/x86/putty.exe  1.1.1.1      46.43.34.31     80      -       zeek     Notice::ACTION_LOG    3600.000000     F\n\n\nExample Alert: Phish::DottedURL\n*******************************\n\nWatch for URLs which only have IP address instead of domain names in them - another sign of maliciousness\n\n\n\t1483418588.406004       CNDcli3Oo5dFqrJNhi      198.124.252.166 46134   128.3.41.120    25      -       -       -       tcp     Phish::DottedURL        Embeded IP in URL http://183.81.171.242/c.jpg from  198.124.252.166     -       198.124.252.166 128.3.41.120 25       -       zeek     Notice::ACTION_LOG      3600.000000     F\n\n\nExample Alert: SensitiveURI\n***************************\n\nGenerates an Alert when a string in URL matches signature defined in \"suspicious_text_in_url\" available in configure-variables-in-this-file.zeek\n\n\t1351714828.429308       CAmJxI1WlO5E5bWxCj      128.3.41.133    1277    209.139.197.113 25      -       -       -       tcp     Phish::SensitiveURI     Suspicious text embeded in URL http://www.foxterciaimobiliaria.com.br/corretor/565/ from  CAmJxI1WlO5E5bWxCj -128.3.41.133    209.139.197.113 25      -       zeek     Notice::ACTION_LOG      3600.000000     F\n\n\nExample Alert: Phish::WatchedFileType\n*************************************\n\nSimple regexp match on file extensions.  This is a noisy notice but useful for logging.  for critical files flagging use (3) above which is malicious file download based on mime-types.\n\n\n\t1481431889.683598       CxGUuzDvWCpUdFI27       74.125.83.52    35030   128.3.41.120    25      -       -       -       tcp     Phish::WatchedFileType  Suspicious filetype embeded in URL http://the.earth.li/~sgtatham/putty/0.67/x86/putty.exe from  74.125.83.52 -74.125.83.52    128.3.41.120    25      -       zeek     Notice::ACTION_LOG      3600.000000     F\n\n\nExample Alert: SensitivePOST\n********************************\n\nThis is generated when a URL in an email is clicked and results in a HTTP Post request. Often this is how passwords are transmitted on phishing sites.\n\n\t1449085047.857802       COuvQB1n4JF3MILQUa      128.3.10.69     57106   67.227.172.217  80      -       -       -       tcp     Phish::HTTPSensitivePOST        Request: /cli/viewd0cument.dropboxxg.20gbfree.secure.verfy.l0gin.user0984987311111-config-l0gin-verfy.user763189713835763/validate.php - Data: type=G+Mail&username=me@me.com&tel=me&password=me&frmLogin:btnLogin1=&frmLogin:btnLogin1=      -       128.3.10.69     67.227.172.217  80      -       zeek     Notice::ACTION_LOG      3600.000000     F\n\n\n\tNotice in alert below: username=me@me.com&tel=me&password=me\n\nExample Alert: SensitivePassword \n********************************\nAlert is triggered when a password transmitted in HTTP SensitivePost is associated with a username related to sites' domain and the password meets the site's password complexity. \n\n\t1467998894.642754       Ce3m7XMMIuScmhJu9       128.3.2.5    64310   104.16.58.61    80      -       -       -       tcp     HTTP::SensitivePasswd   Request: /electacta/login_action.asp - Data: username=blach@lbl.gov&password=Popiszcze$11&rememberMe=on&role=editor&bypass=&rememberUser=1&ignoreWarning=0       -       128.3.2.5    104.16.58.61    80      -       zeek     Notice::ACTION_LOG      3600.000000     F\n\n\t\n\n=========================\nLogging\n=========================\n\nThis module should generate two different logs\n\t- smtpurl_links.log\n\t- smtp_clicked_urls.log\n\n\nsmtpurl_links.log\n-----------------\nThis is a log of all URLs extracted from emails. A sample looks like this\n\nsmtp_clicked_urls.log\n---------------------\nThis is log of URLs from email which are 'clicked' on - ie which are later seen by the HTTP analyzer.\n\n\t#fields\tts\tuid\tid.orig_h\tid.orig_p\tid.resp_h\tid.resp_p\thost\turl\tmail_ts\tmail_uid\tfrom\tto\tsubject\treferrer\n\t#types\ttime\tstring\taddr\tport\taddr\tport\tstring\tstring\ttime\tstring\tstring\tstring\tstring\tstring\n\n\t1449081495.794583\tCtxTCR2Yer0FR1tIBg\t131.243.195.188\t61291\t67.227.172.217\t80\tproposito.net\thttp://proposito.net/cli/viewd0cument.dropboxxg.20gbfree.secure.verfy.l0gin.user0984987311111-config-l0gin-verfy.user763189713835763.htm\t1449081435.863394\tCHhAvVGS1DHFjwGM9\tMaggie Stoeva <mstoe101@gmail.com>\tundisclosed-recipients:;\t(2) Important Document from Maggie Stoeva\t(empty)\n\t1449085026.214280\tCPhDKt12KQPUVbQz06\t128.3.10.69\t57064\t67.227.172.217\t80\tproposito.net\thttp://proposito.net/cli/viewd0cument.dropboxxg.20gbfree.secure.verfy.l0gin.user0984987311111-config-l0gin-verfy.user763189713835763.htm\t1449081435.863394\tCHhAvVGS1DHFjwGM9\tMaggie Stoeva <mstoe101@gmail.com>\tundisclosed-recipients:;\t(2) Important Document from Maggie Stoeva\t(empty)\n"}